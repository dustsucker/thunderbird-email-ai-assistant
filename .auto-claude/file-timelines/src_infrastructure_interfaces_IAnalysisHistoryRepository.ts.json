{
  "file_path": "src/infrastructure/interfaces/IAnalysisHistoryRepository.ts",
  "main_branch_history": [],
  "task_views": {
    "003-confidence-score-display-and-threshold-configurati": {
      "task_id": "003-confidence-score-display-and-threshold-configurati",
      "branch_point": {
        "commit_hash": "f6a57e8f6ff34822855d2c5f711f425bd9bc6897",
        "content": "",
        "timestamp": "2026-01-05T14:48:03.044500"
      },
      "worktree_state": {
        "content": "/**\n * Repository interface for persisting email analysis history.\n *\n * Provides methods for storing and retrieving historical email analysis results\n * including tags, confidence scores, and metadata.\n */\n\n/**\n * Analysis history record containing complete analysis results.\n *\n * Stores the full result of an email analysis including tags, confidence scores,\n * reasoning, and metadata for historical tracking and review.\n */\nexport interface IAnalysisHistoryRecord {\n  /** Unique identifier for this analysis record */\n  id: string;\n  /** Thunderbird message ID that was analyzed */\n  messageId: string;\n  /** Email subject for identification */\n  subject: string;\n  /** Sender email address */\n  from: string;\n  /** List of tag keys that were assigned */\n  tags: string[];\n  /**\n   * Confidence score on 0-100 scale\n   *\n   * Normalized from provider's 0.0-1.0 confidence for easier user understanding.\n   * Higher values indicate greater confidence in the classification.\n   */\n  confidence_score: number;\n  /**\n   * Raw confidence from provider (0.0-1.0)\n   *\n   * Original confidence value returned by the AI provider before normalization.\n   * Retained for backward compatibility and debugging.\n   */\n  confidence: number;\n  /** AI reasoning for the classification */\n  reasoning: string;\n  /** Provider used for analysis (e.g., 'openai', 'ollama') */\n  provider: string;\n  /** Model used for analysis (e.g., 'gpt-4', 'llama2') */\n  model: string;\n  /** Timestamp when analysis was performed (ISO 8601 string) */\n  timestamp: string;\n  /** Whether the email was flagged as a potential scam */\n  is_scam?: boolean;\n  /** Detected sender name */\n  sender?: string;\n  /** Whether sender was consistent with headers */\n  sender_consistent?: boolean | null;\n  /** SPF authentication result */\n  spf_pass?: boolean | null;\n  /** DKIM authentication result */\n  dkim_pass?: boolean | null;\n  /** Whether the analysis result was retrieved from cache */\n  from_cache: boolean;\n  /** Cache key (if result was cached) */\n  cache_key?: string;\n  /** Analysis duration in milliseconds */\n  duration_ms: number;\n}\n\n/**\n * Query options for filtering analysis history.\n */\nexport interface IAnalysisHistoryQuery {\n  /** Filter by message ID */\n  messageId?: string;\n  /** Filter by provider */\n  provider?: string;\n  /** Filter by model */\n  model?: string;\n  /** Filter by minimum confidence score (0-100) */\n  minConfidenceScore?: number;\n  /** Filter by maximum confidence score (0-100) */\n  maxConfidenceScore?: number;\n  /** Filter by tag key (returns records that have this tag) */\n  hasTag?: string;\n  /** Filter by date range start (ISO 8601 string) */\n  startDate?: string;\n  /** Filter by date range end (ISO 8601 string) */\n  endDate?: string;\n  /** Maximum number of records to return */\n  limit?: number;\n  /** Number of records to skip for pagination */\n  offset?: number;\n}\n\n/**\n * Analysis history statistics summary.\n */\nexport interface IAnalysisHistoryStats {\n  /** Total number of analysis records */\n  totalRecords: number;\n  /** Average confidence score (0-100) */\n  averageConfidenceScore: number;\n  /** Most commonly used tags with counts */\n  topTags: Array<{ tag: string; count: number }>;\n  /** Analysis count by provider */\n  analysisByProvider: Array<{ provider: string; count: number }>;\n  /** Date of oldest analysis record */\n  oldestAnalysis: string | null;\n  /** Date of newest analysis record */\n  newestAnalysis: string | null;\n}\n\n/**\n * Repository interface for analysis history persistence.\n *\n * Provides CRUD operations and querying capabilities for email analysis history.\n * Uses browser.storage.local for persistent storage.\n */\nexport interface IAnalysisHistoryRepository {\n  /**\n   * Save an analysis result to history.\n   *\n   * @param record - Analysis record to save\n   * @throws Error if save operation fails\n   */\n  saveAnalysis(record: IAnalysisHistoryRecord): Promise<void>;\n\n  /**\n   * Get a specific analysis record by ID.\n   *\n   * @param id - Analysis record ID\n   * @returns Analysis record or null if not found\n   * @throws Error if retrieval fails\n   */\n  getAnalysis(id: string): Promise<IAnalysisHistoryRecord | null>;\n\n  /**\n   * Get all analysis records for a specific message.\n   *\n   * @param messageId - Thunderbird message ID\n   * @returns Array of analysis records (empty if none found)\n   * @throws Error if retrieval fails\n   */\n  getAnalysisByMessage(messageId: string): Promise<IAnalysisHistoryRecord[]>;\n\n  /**\n   * Query analysis history with filters.\n   *\n   * @param query - Query options for filtering\n   * @returns Array of matching analysis records\n   * @throws Error if query fails\n   */\n  queryAnalysisHistory(query?: IAnalysisHistoryQuery): Promise<IAnalysisHistoryRecord[]>;\n\n  /**\n   * Get statistics about analysis history.\n   *\n   * @param query - Optional query to filter stats calculation\n   * @returns Analysis history statistics\n   * @throws Error if stats calculation fails\n   */\n  getStats(query?: IAnalysisHistoryQuery): Promise<IAnalysisHistoryStats>;\n\n  /**\n   * Delete a specific analysis record.\n   *\n   * @param id - Analysis record ID to delete\n   * @throws Error if deletion fails\n   */\n  deleteAnalysis(id: string): Promise<void>;\n\n  /**\n   * Delete all analysis records for a specific message.\n   *\n   * @param messageId - Thunderbird message ID\n   * @returns Number of records deleted\n   * @throws Error if deletion fails\n   */\n  deleteAnalysisByMessage(messageId: string): Promise<number>;\n\n  /**\n   * Clear all analysis history.\n   *\n   * This will remove all analysis records permanently.\n   * Use with caution.\n   *\n   * @returns Number of records deleted\n   * @throws Error if clear operation fails\n   */\n  clearAll(): Promise<number>;\n\n  /**\n   * Get total count of analysis records.\n   *\n   * @param query - Optional query to filter count\n   * @returns Number of matching records\n   * @throws Error if count fails\n   */\n  count(query?: IAnalysisHistoryQuery): Promise<number>;\n}\n",
        "last_modified": "2026-01-05T19:59:00.206532"
      },
      "task_intent": {
        "title": "Confidence Score Display and Threshold Configuration",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-05T14:48:03.064846",
  "last_updated": "2026-01-05T14:48:03.068308"
}