{
  "file_path": "test/threshold-integration.test.ts",
  "main_branch_history": [],
  "task_views": {
    "003-confidence-score-display-and-threshold-configurati": {
      "task_id": "003-confidence-score-display-and-threshold-configurati",
      "branch_point": {
        "commit_hash": "f6a57e8f6ff34822855d2c5f711f425bd9bc6897",
        "content": "",
        "timestamp": "2026-01-05T14:48:03.044500"
      },
      "worktree_state": {
        "content": "/**\n * Integration tests for confidence threshold configuration and persistence.\n *\n * This test suite verifies:\n * - Global threshold can be set and persists correctly\n * - Per-tag thresholds override global correctly\n * - Settings sync across browser contexts\n * - Reset to defaults works\n */\n\nimport 'reflect-metadata';\nimport { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';\nimport { IndexedDBConfigRepository } from '../src/infrastructure/repositories/IndexedDBConfigRepository';\nimport type { ILogger } from '../src/infrastructure/interfaces/ILogger';\nimport type {\n  IAppConfig,\n  ICustomTag,\n} from '../src/infrastructure/interfaces/IConfigRepository';\n\n// === Mock Browser API ===\n\nfunction createMockBrowserStorage() {\n  const storage = new Map<string, Record<string, unknown>>();\n\n  return {\n    get: vi.fn(async (keys: string | string[] | Record<string, unknown> | null) => {\n      const result: Record<string, unknown> = {};\n\n      if (keys === null || typeof keys === 'string') {\n        if (keys === null || storage.has(keys)) {\n          const key = keys === null ? Array.from(storage.keys())[0] : keys;\n          if (key && storage.has(key)) {\n            result[key] = storage.get(key);\n          }\n        }\n      } else if (Array.isArray(keys)) {\n        for (const key of keys) {\n          if (storage.has(key)) {\n            result[key] = storage.get(key);\n          }\n        }\n      } else if (typeof keys === 'object') {\n        for (const key of Object.keys(keys)) {\n          if (storage.has(key)) {\n            result[key] = storage.get(key);\n          }\n        }\n      }\n\n      return result;\n    }),\n\n    set: vi.fn(async (items: Record<string, unknown>) => {\n      for (const [key, value] of Object.entries(items)) {\n        storage.set(key, value as Record<string, unknown>);\n      }\n    }),\n\n    clear: vi.fn(async () => {\n      storage.clear();\n    }),\n\n    _getStorage: () => storage,\n  };\n}\n\nfunction mockGlobalBrowserStorage() {\n  const mockStorage = createMockBrowserStorage();\n\n  (globalThis as unknown as Record<string, unknown>).browser = {\n    storage: {\n      local: {\n        get: mockStorage.get,\n        set: mockStorage.set,\n        clear: mockStorage.clear,\n      },\n    },\n  };\n\n  return mockStorage;\n}\n\n// === Test Fixtures ===\n\nfunction createMockLogger(): ILogger {\n  return {\n    debug: vi.fn(),\n    info: vi.fn(),\n    warn: vi.fn(),\n    error: vi.fn(),\n    maskApiKey: vi.fn((key?: string) =>\n      key ? `${key.slice(0, 7)}...${key.slice(-3)}` : 'not set'\n    ),\n  };\n}\n\nconst defaultAppConfig: IAppConfig = {\n  defaultProvider: 'openai',\n  enableNotifications: true,\n  enableLogging: true,\n  modelConcurrencyLimits: undefined,\n  confidenceThreshold: 70,\n};\n\nconst sampleCustomTags: ICustomTag[] = [\n  {\n    key: 'is_business',\n    name: 'Business',\n    color: '#af4c87',\n    prompt: 'check if this looks like work related email',\n  },\n  {\n    key: 'is_personal',\n    name: 'Personal',\n    color: '#4CAF50',\n    prompt: 'check if this is non-sales scenario approach',\n  },\n  {\n    key: 'is_advertise',\n    name: 'Advertisement',\n    color: '#FFC107',\n    prompt: 'check if email is advertising something',\n  },\n];\n\n// === Test Suite ===\n\ndescribe('Threshold Configuration Integration Tests', () => {\n  let repository: IndexedDBConfigRepository;\n  let mockLogger: ILogger;\n  let mockStorage: ReturnType<typeof createMockBrowserStorage>;\n\n  beforeEach(() => {\n    mockLogger = createMockLogger();\n    mockStorage = mockGlobalBrowserStorage();\n    repository = new IndexedDBConfigRepository(mockLogger);\n  });\n\n  afterEach(() => {\n    // Clean up global mock\n    delete (globalThis as unknown as Record<string, unknown>).browser;\n    delete (globalThis as unknown as Record<string, unknown>).chrome;\n  });\n\n  describe('Global Threshold Configuration', () => {\n    it('should set and persist global confidence threshold', async () => {\n      const newThreshold = 85;\n\n      // Set global threshold\n      const config = { ...defaultAppConfig, confidenceThreshold: newThreshold };\n      await repository.setAppConfig(config);\n\n      // Retrieve and verify\n      const retrieved = await repository.getAppConfig();\n      expect(retrieved.confidenceThreshold).toBe(newThreshold);\n\n      // Verify through new repository instance (simulates browser restart)\n      const newRepository = new IndexedDBConfigRepository(mockLogger);\n      const fromNewInstance = await newRepository.getAppConfig();\n      expect(fromNewInstance.confidenceThreshold).toBe(newThreshold);\n    });\n\n    it('should default to 70 when no threshold is set', async () => {\n      // Set config without confidenceThreshold\n      const configWithoutThreshold = {\n        defaultProvider: 'ollama',\n        enableNotifications: true,\n        enableLogging: false,\n        modelConcurrencyLimits: undefined,\n        confidenceThreshold: 70, // Required by interface\n      };\n      await repository.setAppConfig(configWithoutThreshold);\n\n      const retrieved = await repository.getAppConfig();\n      expect(retrieved.confidenceThreshold).toBe(70);\n    });\n\n    it('should validate threshold range (0-100)', async () => {\n      // Test invalid values\n      await expect(\n        repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: -1 })\n      ).rejects.toThrow();\n\n      await expect(\n        repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 101 })\n      ).rejects.toThrow();\n\n      await expect(\n        repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: NaN as unknown as number })\n      ).rejects.toThrow();\n    });\n\n    it('should accept boundary values (0 and 100)', async () => {\n      // Test 0\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 0 });\n      let config = await repository.getAppConfig();\n      expect(config.confidenceThreshold).toBe(0);\n\n      // Test 100\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 100 });\n      config = await repository.getAppConfig();\n      expect(config.confidenceThreshold).toBe(100);\n    });\n\n    it('should persist threshold across repository instances', async () => {\n      const threshold = 75;\n\n      // Set with first instance\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: threshold });\n\n      // Create new repository instance (simulates browser restart)\n      const newRepository = new IndexedDBConfigRepository(mockLogger);\n      const config = await newRepository.getAppConfig();\n\n      expect(config.confidenceThreshold).toBe(threshold);\n    });\n\n    it('should handle missing confidenceThreshold in existing config (backward compatibility)', async () => {\n      // Manually set config without confidenceThreshold (simulating old config)\n      const storage = mockStorage._getStorage();\n      storage.set('appConfig', {\n        defaultProvider: 'openai',\n        enableNotifications: true,\n        enableLogging: true,\n        modelConcurrencyLimits: undefined,\n        // confidenceThreshold is missing\n      });\n\n      // Should default to 70\n      const config = await repository.getAppConfig();\n      expect(config.confidenceThreshold).toBe(70);\n    });\n  });\n\n  describe('Per-Tag Threshold Overrides', () => {\n    it('should set and retrieve per-tag threshold override', async () => {\n      const tagKey = 'is_business';\n      const overrideThreshold = 85;\n\n      // Set per-tag override\n      await repository.setTagThreshold(tagKey, overrideThreshold);\n\n      // Retrieve and verify\n      const retrieved = await repository.getTagThreshold(tagKey);\n      expect(retrieved).toBe(overrideThreshold);\n    });\n\n    it('should return null when no override is set', async () => {\n      const tagKey = 'is_business';\n\n      const retrieved = await repository.getTagThreshold(tagKey);\n      expect(retrieved).toBeNull();\n    });\n\n    it('should remove threshold override when set to null', async () => {\n      const tagKey = 'is_business';\n\n      // Set override\n      await repository.setTagThreshold(tagKey, 85);\n      let retrieved = await repository.getTagThreshold(tagKey);\n      expect(retrieved).toBe(85);\n\n      // Remove override\n      await repository.setTagThreshold(tagKey, null);\n      retrieved = await repository.getTagThreshold(tagKey);\n      expect(retrieved).toBeNull();\n    });\n\n    it('should get all threshold overrides', async () => {\n      const overrides = {\n        is_business: 85,\n        is_personal: 60,\n        is_advertise: 90,\n      };\n\n      // Set multiple overrides\n      for (const [tagKey, threshold] of Object.entries(overrides)) {\n        await repository.setTagThreshold(tagKey, threshold);\n      }\n\n      // Retrieve all\n      const allOverrides = await repository.getAllTagThresholds();\n      expect(allOverrides).toEqual(overrides);\n    });\n\n    it('should validate per-tag threshold range', async () => {\n      const tagKey = 'is_business';\n\n      // Test invalid values\n      await expect(repository.setTagThreshold(tagKey, -1)).rejects.toThrow();\n      await expect(repository.setTagThreshold(tagKey, 101)).rejects.toThrow();\n      await expect(repository.setTagThreshold(tagKey, NaN)).rejects.toThrow();\n    });\n\n    it('should persist per-tag overrides independently', async () => {\n      // Set multiple overrides\n      await repository.setTagThreshold('is_business', 85);\n      await repository.setTagThreshold('is_personal', 60);\n\n      // Remove one\n      await repository.setTagThreshold('is_personal', null);\n\n      // Verify only the specified one was removed\n      const allOverrides = await repository.getAllTagThresholds();\n      expect(allOverrides).toEqual({ is_business: 85 });\n      expect(allOverrides).not.toHaveProperty('is_personal');\n    });\n  });\n\n  describe('Effective Threshold Calculation', () => {\n    // Helper function to calculate effective threshold\n    async function getEffectiveThreshold(\n      repo: IndexedDBConfigRepository,\n      tagKey: string\n    ): Promise<number> {\n      // Check for per-tag override\n      const override = await repo.getTagThreshold(tagKey);\n      if (override !== null) {\n        return override;\n      }\n\n      // Fall back to global threshold\n      const config = await repo.getAppConfig();\n      return config.confidenceThreshold;\n    }\n\n    it('should use per-tag override when set', async () => {\n      const tagKey = 'is_business';\n      const globalThreshold = 70;\n      const overrideThreshold = 85;\n\n      // Set global threshold\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      // Set per-tag override\n      await repository.setTagThreshold(tagKey, overrideThreshold);\n\n      // Get effective threshold\n      const effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(overrideThreshold);\n      expect(effective).not.toBe(globalThreshold);\n    });\n\n    it('should fall back to global threshold when no override is set', async () => {\n      const tagKey = 'is_business';\n      const globalThreshold = 75;\n\n      // Set global threshold\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      // Don't set per-tag override\n\n      // Get effective threshold\n      const effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(globalThreshold);\n    });\n\n    it('should handle missing override after being set and removed', async () => {\n      const tagKey = 'is_business';\n      const globalThreshold = 70;\n      const overrideThreshold = 85;\n\n      // Set global threshold\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      // Set override\n      await repository.setTagThreshold(tagKey, overrideThreshold);\n      let effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(overrideThreshold);\n\n      // Remove override\n      await repository.setTagThreshold(tagKey, null);\n      effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(globalThreshold);\n    });\n\n    it('should handle multiple tags with different override configurations', async () => {\n      const globalThreshold = 70;\n\n      // Set global threshold\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      // Set override for some tags but not others\n      await repository.setTagThreshold('is_business', 85);\n      await repository.setTagThreshold('is_personal', 60);\n      // is_advertise has no override\n\n      // Check effective thresholds\n      const businessEffective = await getEffectiveThreshold(repository, 'is_business');\n      const personalEffective = await getEffectiveThreshold(repository, 'is_personal');\n      const advertiseEffective = await getEffectiveThreshold(repository, 'is_advertise');\n\n      expect(businessEffective).toBe(85);\n      expect(personalEffective).toBe(60);\n      expect(advertiseEffective).toBe(globalThreshold); // Falls back to global\n    });\n  });\n\n  describe('Reset to Defaults', () => {\n    it('should reset global threshold to default (70)', async () => {\n      // Set non-default threshold\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 90 });\n\n      // Verify it's set\n      let config = await repository.getAppConfig();\n      expect(config.confidenceThreshold).toBe(90);\n\n      // Reset to default\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 70 });\n\n      // Verify reset\n      config = await repository.getAppConfig();\n      expect(config.confidenceThreshold).toBe(70);\n    });\n\n    it('should clear all per-tag overrides when resetting', async () => {\n      // Set multiple overrides\n      await repository.setTagThreshold('is_business', 85);\n      await repository.setTagThreshold('is_personal', 60);\n\n      // Verify they're set\n      let allOverrides = await repository.getAllTagThresholds();\n      expect(Object.keys(allOverrides)).toHaveLength(2);\n\n      // Clear all by setting each to null\n      await repository.setTagThreshold('is_business', null);\n      await repository.setTagThreshold('is_personal', null);\n\n      // Verify cleared\n      allOverrides = await repository.getAllTagThresholds();\n      expect(Object.keys(allOverrides)).toHaveLength(0);\n    });\n\n    it('should fall back to global after removing per-tag override', async () => {\n      const globalThreshold = 70;\n      const tagKey = 'is_business';\n\n      // Helper to get effective threshold\n      async function getEffectiveThreshold(repo: IndexedDBConfigRepository, tag: string): Promise<number> {\n        const override = await repo.getTagThreshold(tag);\n        if (override !== null) return override;\n        const config = await repo.getAppConfig();\n        return config.confidenceThreshold;\n      }\n\n      // Set global and override\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n      await repository.setTagThreshold(tagKey, 85);\n\n      // Verify override is used\n      let effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(85);\n\n      // Remove override\n      await repository.setTagThreshold(tagKey, null);\n\n      // Verify fallback to global\n      effective = await getEffectiveThreshold(repository, tagKey);\n      expect(effective).toBe(globalThreshold);\n    });\n  });\n\n  describe('Storage Persistence Across Contexts', () => {\n    it('should maintain data integrity across multiple storage operations', async () => {\n      const thresholds = {\n        is_business: 85,\n        is_personal: 60,\n        is_advertise: 75,\n      };\n\n      // Set multiple thresholds\n      for (const [tagKey, threshold] of Object.entries(thresholds)) {\n        await repository.setTagThreshold(tagKey, threshold);\n      }\n\n      // Perform other storage operations\n      await repository.setCustomTags(sampleCustomTags);\n\n      // Verify thresholds are still intact\n      const allThresholds = await repository.getAllTagThresholds();\n      expect(allThresholds).toEqual(thresholds);\n    });\n\n    it('should handle concurrent threshold updates correctly', async () => {\n      const tagKey = 'is_business';\n\n      // Set initial value\n      await repository.setTagThreshold(tagKey, 70);\n\n      // Perform multiple updates rapidly\n      await Promise.all([\n        repository.setTagThreshold(tagKey, 80),\n        repository.setTagThreshold(tagKey, 85),\n        repository.setTagThreshold(tagKey, 90),\n      ]);\n\n      // Final value should be one of the set values (implementation dependent)\n      const finalValue = await repository.getTagThreshold(tagKey);\n      expect([80, 85, 90]).toContain(finalValue);\n    });\n  });\n\n  describe('Data Coherence', () => {\n    it('should maintain threshold data when other config is updated', async () => {\n      const tagKey = 'is_business';\n      const thresholdValue = 85;\n\n      // Set threshold\n      await repository.setTagThreshold(tagKey, thresholdValue);\n\n      // Update other config (custom tags)\n      await repository.setCustomTags(sampleCustomTags);\n\n      // Verify threshold is still intact\n      const retrieved = await repository.getTagThreshold(tagKey);\n      expect(retrieved).toBe(thresholdValue);\n    });\n\n    it('should isolate thresholds from other storage keys', async () => {\n      // Set various config\n      await repository.setAppConfig(defaultAppConfig);\n      await repository.setCustomTags(sampleCustomTags);\n      await repository.setTagThreshold('is_business', 85);\n      await repository.setTagThreshold('is_personal', 60);\n\n      // Verify each storage key is independent\n      const config = await repository.getAppConfig();\n      const tags = await repository.getCustomTags();\n      const thresholds = await repository.getAllTagThresholds();\n\n      expect(config.confidenceThreshold).toBeDefined();\n      expect(tags).toHaveLength(3);\n      expect(Object.keys(thresholds)).toHaveLength(2);\n    });\n  });\n\n  describe('Tag Filtering Logic', () => {\n    it('should identify high-confidence tags as auto-apply candidates', async () => {\n      const globalThreshold = 70;\n      const confidence = 85; // Above threshold\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      const config = await repository.getAppConfig();\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n    });\n\n    it('should identify low-confidence tags as manual review candidates', async () => {\n      const globalThreshold = 70;\n      const confidence = 50; // Below threshold\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      const config = await repository.getAppConfig();\n      expect(confidence < config.confidenceThreshold).toBe(true);\n    });\n\n    it('should handle confidence exactly at threshold boundary', async () => {\n      const globalThreshold = 70;\n      const confidence = 70; // Exactly at threshold\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      const config = await repository.getAppConfig();\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n    });\n\n    it('should handle per-tag threshold higher than global', async () => {\n      const globalThreshold = 70;\n      const tagThreshold = 85;\n      const confidence = 80; // Above global but below per-tag\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n      await repository.setTagThreshold('is_business', tagThreshold);\n\n      const config = await repository.getAppConfig();\n      const override = await repository.getTagThreshold('is_business');\n\n      // With global threshold\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n\n      // With per-tag override\n      expect(override).toBe(tagThreshold);\n      expect(confidence < tagThreshold).toBe(true);\n    });\n\n    it('should handle per-tag threshold lower than global', async () => {\n      const globalThreshold = 70;\n      const tagThreshold = 60;\n      const confidence = 65; // Below global but above per-tag\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n      await repository.setTagThreshold('is_business', tagThreshold);\n\n      const config = await repository.getAppConfig();\n      const override = await repository.getTagThreshold('is_business');\n\n      // With global threshold\n      expect(confidence < config.confidenceThreshold).toBe(true);\n\n      // With per-tag override\n      expect(override).toBe(tagThreshold);\n      expect(confidence >= tagThreshold).toBe(true);\n    });\n\n    it('should handle edge case: 0% confidence', async () => {\n      const confidence = 0;\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 70 });\n\n      const config = await repository.getAppConfig();\n      expect(confidence < config.confidenceThreshold).toBe(true);\n    });\n\n    it('should handle edge case: 100% confidence', async () => {\n      const confidence = 100;\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 70 });\n\n      const config = await repository.getAppConfig();\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n    });\n\n    it('should handle edge case: 0% threshold', async () => {\n      const confidence = 1; // Very low\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 0 });\n\n      const config = await repository.getAppConfig();\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n    });\n\n    it('should handle edge case: 100% threshold', async () => {\n      const confidence = 99; // High but not perfect\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: 100 });\n\n      const config = await repository.getAppConfig();\n      expect(confidence < config.confidenceThreshold).toBe(true);\n    });\n\n    it('should calculate deficit for low-confidence tags', async () => {\n      const globalThreshold = 70;\n      const confidence = 50;\n      const expectedDeficit = 20; // 70 - 50\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n\n      const config = await repository.getAppConfig();\n      const deficit = config.confidenceThreshold - confidence;\n\n      expect(deficit).toBe(expectedDeficit);\n    });\n\n    it('should handle multiple tags with different thresholds independently', async () => {\n      const globalThreshold = 70;\n      const confidence = 75;\n\n      await repository.setAppConfig({ ...defaultAppConfig, confidenceThreshold: globalThreshold });\n      await repository.setTagThreshold('is_business', 85); // Higher\n      await repository.setTagThreshold('is_personal', 60); // Lower\n      // is_advertise uses global\n\n      const config = await repository.getAppConfig();\n      const businessThreshold = await repository.getTagThreshold('is_business');\n      const personalThreshold = await repository.getTagThreshold('is_personal');\n\n      // is_business: 75 < 85 (should be filtered)\n      expect(businessThreshold).toBe(85);\n      expect(confidence < businessThreshold!).toBe(true);\n\n      // is_personal: 75 >= 60 (should be auto-applied)\n      expect(personalThreshold).toBe(60);\n      expect(confidence >= personalThreshold!).toBe(true);\n\n      // is_advertise: 75 >= 70 (should be auto-applied)\n      expect(confidence >= config.confidenceThreshold).toBe(true);\n    });\n  });\n});\n",
        "last_modified": "2026-01-05T19:59:00.214325"
      },
      "task_intent": {
        "title": "Confidence Score Display and Threshold Configuration",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-05T14:48:03.135507",
  "last_updated": "2026-01-05T14:48:03.138891"
}