{
  "file_path": "src/interfaces/options/ReviewQueueUI.ts",
  "main_branch_history": [],
  "task_views": {
    "003-confidence-score-display-and-threshold-configurati": {
      "task_id": "003-confidence-score-display-and-threshold-configurati",
      "branch_point": {
        "commit_hash": "f6a57e8f6ff34822855d2c5f711f425bd9bc6897",
        "content": "",
        "timestamp": "2026-01-05T14:48:03.044500"
      },
      "worktree_state": {
        "content": "/**\n * Review Queue UI Component\n *\n * Manages display and actions for the manual review queue.\n * Shows classifications with low confidence scores that require manual review.\n *\n * @module interfaces/options/ReviewQueueUI\n */\n\nimport { injectable, inject } from 'tsyringe';\nimport type { IReviewQueueRepository } from '@/infrastructure/interfaces/IReviewQueueRepository';\nimport type { IReviewQueueItem, ReviewStatus } from '@/infrastructure/interfaces/IReviewQueueRepository';\nimport type { ILogger } from '@/infrastructure/interfaces/ILogger';\n\n// ============================================================================\n// DOM Element Interfaces\n// ============================================================================\n\n/**\n * Review Queue DOM Elements\n */\ninterface ReviewQueueElements {\n  container: HTMLDivElement;\n  statsContainer: HTMLDivElement;\n  statusFilter: HTMLSelectElement;\n  confidenceFilter: HTMLSelectElement;\n  sortBy: HTMLSelectElement;\n  refreshBtn: HTMLButtonElement;\n  clearReviewedBtn: HTMLButtonElement;\n}\n\n// ============================================================================\n// Type Definitions\n// ============================================================================\n\n/**\n * Filter options for review queue\n */\ninterface ReviewQueueFilters {\n  status: string;\n  confidence: string;\n  sortBy: string;\n}\n\n// ============================================================================\n// Review Queue UI Implementation\n// ============================================================================\n\n/**\n * Review Queue UI Component\n *\n * Displays and manages the manual review queue for low-confidence classifications.\n * Shows confidence scores, allows filtering, sorting, and bulk actions.\n *\n * @example\n * ```typescript\n * const reviewUI = container.resolve<ReviewQueueUI>(ReviewQueueUI);\n * await reviewUI.loadReviewQueue();\n * reviewUI.render();\n * ```\n */\n@injectable()\nexport class ReviewQueueUI {\n  // ==========================================================================\n  // Private Fields\n  // ==========================================================================\n\n  private readonly reviewQueueRepository: IReviewQueueRepository;\n  private readonly logger: ILogger;\n  private elements: ReviewQueueElements | null = null;\n  private currentItems: IReviewQueueItem[] = [];\n  private filters: ReviewQueueFilters = {\n    status: 'pending',\n    confidence: 'all',\n    sortBy: 'confidence-asc',\n  };\n\n  // ==========================================================================\n  // Constructor\n  // ==========================================================================\n\n  constructor(\n    @inject('IReviewQueueRepository') reviewQueueRepository: IReviewQueueRepository,\n    @inject('ILogger') logger: ILogger\n  ) {\n    this.reviewQueueRepository = reviewQueueRepository;\n    this.logger = logger;\n    this.logger.debug('ReviewQueueUI initialized');\n  }\n\n  // ==========================================================================\n  // Public Methods\n  // ==========================================================================\n\n  /**\n   * Renders the review queue UI to the DOM.\n   *\n   * Sets up event listeners for filters, refresh, and bulk actions.\n   */\n  render(): void {\n    this.logger.debug('Rendering review queue UI');\n\n    this.elements = this.getDOMElements();\n\n    // Setup filter change handlers\n    this.elements.statusFilter.addEventListener('change', () => {\n      this.filters.status = this.elements!.statusFilter.value;\n      this.loadAndRenderItems();\n    });\n\n    this.elements.confidenceFilter.addEventListener('change', () => {\n      this.filters.confidence = this.elements!.confidenceFilter.value;\n      this.loadAndRenderItems();\n    });\n\n    this.elements.sortBy.addEventListener('change', () => {\n      this.filters.sortBy = this.elements!.sortBy.value;\n      this.loadAndRenderItems();\n    });\n\n    // Setup refresh button\n    this.elements.refreshBtn.addEventListener('click', () => {\n      this.loadAndRenderItems();\n    });\n\n    // Setup clear reviewed button\n    this.elements.clearReviewedBtn.addEventListener('click', () => {\n      this.clearReviewedItems();\n    });\n\n    this.logger.debug('Review queue UI rendered');\n  }\n\n  /**\n   * Loads review queue items from repository and renders them.\n   */\n  async loadReviewQueue(): Promise<void> {\n    this.logger.debug('Loading review queue');\n\n    try {\n      await this.loadAndRenderItems();\n      this.logger.debug('Review queue loaded successfully');\n    } catch (error) {\n      this.logger.error('Failed to load review queue', { error });\n      this.showError('Fehler beim Laden der Review-Warteschlange');\n    }\n  }\n\n  // ==========================================================================\n  // Private Methods\n  // ==========================================================================\n\n  /**\n   * Gets DOM elements for review queue UI.\n   */\n  private getDOMElements(): ReviewQueueElements {\n    const container = document.getElementById('review-queue-container') as HTMLDivElement;\n    const statsContainer = document.getElementById('review-stats') as HTMLDivElement;\n    const statusFilter = document.getElementById('review-status-filter') as HTMLSelectElement;\n    const confidenceFilter = document.getElementById('review-confidence-filter') as HTMLSelectElement;\n    const sortBy = document.getElementById('review-sort-by') as HTMLSelectElement;\n    const refreshBtn = document.getElementById('refresh-review-queue-btn') as HTMLButtonElement;\n    const clearReviewedBtn = document.getElementById('clear-reviewed-btn') as HTMLButtonElement;\n\n    if (!container || !statsContainer || !statusFilter || !confidenceFilter || !sortBy || !refreshBtn || !clearReviewedBtn) {\n      throw new Error('Required review queue DOM elements not found');\n    }\n\n    return { container, statsContainer, statusFilter, confidenceFilter, sortBy, refreshBtn, clearReviewedBtn };\n  }\n\n  /**\n   * Loads items from repository and renders them.\n   */\n  private async loadAndRenderItems(): Promise<void> {\n    // Build query from filters\n    const query = this.buildQuery();\n\n    // Fetch items\n    this.currentItems = await this.reviewQueueRepository.queryQueue(query);\n\n    // Apply sorting\n    this.applySorting();\n\n    // Render stats and items\n    this.renderStats();\n    this.renderItems();\n  }\n\n  /**\n   * Builds query object from current filters.\n   */\n  private buildQuery(): any {\n    const query: any = {};\n\n    // Status filter\n    if (this.filters.status !== 'all') {\n      query.status = this.filters.status as ReviewStatus;\n    }\n\n    // Confidence filter\n    if (this.filters.confidence !== 'all') {\n      const [min, max] = this.filters.confidence.split('-').map(Number);\n      query.minConfidenceScore = min;\n      query.maxConfidenceScore = max;\n    }\n\n    return query;\n  }\n\n  /**\n   * Applies sorting to current items.\n   */\n  private applySorting(): void {\n    const sort = this.filters.sortBy;\n\n    if (sort === 'confidence-asc') {\n      this.currentItems.sort((a, b) => a.confidenceScore - b.confidenceScore);\n    } else if (sort === 'confidence-desc') {\n      this.currentItems.sort((a, b) => b.confidenceScore - a.confidenceScore);\n    } else if (sort === 'date-desc') {\n      this.currentItems.sort((a, b) => new Date(b.addedAt).getTime() - new Date(a.addedAt).getTime());\n    } else if (sort === 'date-asc') {\n      this.currentItems.sort((a, b) => new Date(a.addedAt).getTime() - new Date(b.addedAt).getTime());\n    }\n  }\n\n  /**\n   * Renders statistics for the review queue.\n   */\n  private renderStats(): void {\n    const stats = this.elements!.statsContainer;\n\n    if (this.currentItems.length === 0) {\n      stats.innerHTML = '<p class=\"help-text\">Keine Artikel in der Review-Warteschlange</p>';\n      return;\n    }\n\n    // Calculate average confidence\n    const avgConfidence =\n      this.currentItems.reduce((sum, item) => sum + item.confidenceScore, 0) / this.currentItems.length;\n\n    stats.innerHTML = `\n      <div class=\"review-stat-item\">\n        <span class=\"stat-label\">Gesamt:</span>\n        <span class=\"stat-value\">${this.currentItems.length}</span>\n      </div>\n      <div class=\"review-stat-item\">\n        <span class=\"stat-label\">Durchschnittliche Konfidenz:</span>\n        <span class=\"stat-value ${this.getConfidenceClass(avgConfidence)}\">${avgConfidence.toFixed(1)}%</span>\n      </div>\n    `;\n  }\n\n  /**\n   * Renders review queue items to the DOM.\n   */\n  private renderItems(): void {\n    const container = this.elements!.container;\n\n    if (this.currentItems.length === 0) {\n      container.innerHTML = `\n        <div class=\"review-empty-state\">\n          <p>Keine Artikel in der Review-Warteschlange mit den aktuellen Filtern.</p>\n        </div>\n      `;\n      return;\n    }\n\n    container.innerHTML = '';\n\n    this.currentItems.forEach((item) => {\n      const itemElement = this.createItemElement(item);\n      container.appendChild(itemElement);\n    });\n  }\n\n  /**\n   * Creates a DOM element for a review queue item.\n   */\n  private createItemElement(item: IReviewQueueItem): HTMLElement {\n    const div = document.createElement('div');\n    div.className = 'review-item';\n    div.dataset.itemId = item.id;\n\n    const confidenceClass = this.getConfidenceClass(item.confidenceScore);\n    const statusBadge = this.getStatusBadge(item.status);\n\n    div.innerHTML = `\n      <div class=\"review-item-header\">\n        <div class=\"review-item-subject\">${this.escapeHtml(item.subject)}</div>\n        <div class=\"review-item-meta\">\n          ${statusBadge}\n          <span class=\"review-item-confidence ${confidenceClass}\">\n            Konfidenz: ${item.confidenceScore.toFixed(1)}%\n          </span>\n        </div>\n      </div>\n      <div class=\"review-item-details\">\n        <div class=\"review-item-from\">Von: ${this.escapeHtml(item.from)}</div>\n        <div class=\"review-item-date\">${new Date(item.timestamp).toLocaleDateString('de-DE')}</div>\n        <div class=\"review-item-provider\">${item.provider} (${item.model})</div>\n      </div>\n      <div class=\"review-item-tags\">\n        <strong>Tags zur \u00dcberpr\u00fcfung:</strong>\n        ${item.manualReviewTags.map((tag) => this.createTagBadge(tag)).join('')}\n      </div>\n      ${item.reasoning ? `<div class=\"review-item-reasoning\"><strong>Begr\u00fcndung:</strong> ${this.escapeHtml(item.reasoning)}</div>` : ''}\n      <div class=\"review-item-actions\">\n        <button class=\"btn-approve\" data-item-id=\"${item.id}\">\u2713 Genehmigen</button>\n        <button class=\"btn-reject\" data-item-id=\"${item.id}\">\u2717 Ablehnen</button>\n        <button class=\"btn-ignore\" data-item-id=\"${item.id}\">\u2212 Ignorieren</button>\n      </div>\n    `;\n\n    // Setup action buttons\n    const approveBtn = div.querySelector('.btn-approve') as HTMLButtonElement;\n    const rejectBtn = div.querySelector('.btn-reject') as HTMLButtonElement;\n    const ignoreBtn = div.querySelector('.btn-ignore') as HTMLButtonElement;\n\n    approveBtn.addEventListener('click', () => this.updateItemStatus(item.id, 'approved'));\n    rejectBtn.addEventListener('click', () => this.updateItemStatus(item.id, 'rejected'));\n    ignoreBtn.addEventListener('click', () => this.updateItemStatus(item.id, 'ignored'));\n\n    return div;\n  }\n\n  /**\n   * Creates a badge for a manual review tag.\n   */\n  private createTagBadge(tag: { tag: string; confidence: number; threshold: number }): string {\n    const confidenceClass = this.getConfidenceClass(tag.confidence);\n    return `\n      <span class=\"review-tag-badge ${confidenceClass}\">\n        ${this.escapeHtml(tag.tag)}\n        <span class=\"review-tag-confidence\">${tag.confidence.toFixed(0)}% < ${tag.threshold}%</span>\n      </span>\n    `;\n  }\n\n  /**\n   * Gets CSS class for confidence level.\n   */\n  private getConfidenceClass(confidence: number): string {\n    if (confidence >= 80) return 'confidence-high';\n    if (confidence >= 60) return 'confidence-medium';\n    return 'confidence-low';\n  }\n\n  /**\n   * Gets status badge HTML.\n   */\n  private getStatusBadge(status: ReviewStatus): string {\n    const badges: Record<ReviewStatus, string> = {\n      pending: '<span class=\"status-badge status-pending\">Ausstehend</span>',\n      approved: '<span class=\"status-badge status-approved\">Genehmigt</span>',\n      rejected: '<span class=\"status-badge status-rejected\">Abgelehnt</span>',\n      ignored: '<span class=\"status-badge status-ignored\">Ignoriert</span>',\n    };\n    return badges[status] || '';\n  }\n\n  /**\n   * Updates the status of a review queue item.\n   */\n  private async updateItemStatus(itemId: string, status: ReviewStatus): Promise<void> {\n    try {\n      await this.reviewQueueRepository.updateStatus(itemId, status);\n      this.logger.info('Review queue item status updated', { itemId, status });\n      await this.loadAndRenderItems();\n    } catch (error) {\n      this.logger.error('Failed to update item status', { itemId, status, error });\n      this.showError('Fehler beim Aktualisieren des Status');\n    }\n  }\n\n  /**\n   * Clears all reviewed items from the queue.\n   */\n  private async clearReviewedItems(): Promise<void> {\n    if (!confirm('M\u00f6chten Sie alle \u00fcberpr\u00fcften Artikel (genehmigt/abgelehnt/ignoriert) aus der Warteschlange entfernen?')) {\n      return;\n    }\n\n    try {\n      const allItems = await this.reviewQueueRepository.queryQueue();\n      const reviewedItems = allItems.filter((item) => item.status !== 'pending');\n\n      for (const item of reviewedItems) {\n        await this.reviewQueueRepository.deleteItem(item.id);\n      }\n\n      this.logger.info('Cleared reviewed items', { count: reviewedItems.length });\n      await this.loadAndRenderItems();\n    } catch (error) {\n      this.logger.error('Failed to clear reviewed items', { error });\n      this.showError('Fehler beim Entfernen \u00fcberpr\u00fcfter Artikel');\n    }\n  }\n\n  /**\n   * Escapes HTML to prevent XSS.\n   */\n  private escapeHtml(text: string): string {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  /**\n   * Shows an error message to the user.\n   */\n  private showError(message: string): void {\n    // Use the existing error display overlay if available\n    const overlay = document.getElementById('error-display-overlay') as HTMLDivElement;\n    const messageEl = document.getElementById('error-display-message') as HTMLParagraphElement;\n\n    if (overlay && messageEl) {\n      messageEl.textContent = message;\n      overlay.style.display = 'block';\n    } else {\n      alert(message);\n    }\n  }\n}\n",
        "last_modified": "2026-01-05T19:59:00.212894"
      },
      "task_intent": {
        "title": "Confidence Score Display and Threshold Configuration",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-05T14:48:03.171353",
  "last_updated": "2026-01-05T14:48:03.174556"
}