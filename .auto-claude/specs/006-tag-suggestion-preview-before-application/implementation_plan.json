{
  "specId": "006-tag-suggestion-preview-before-application",
  "specTitle": "Tag Suggestion Preview Before Application",
  "description": "Show proposed tags to users before applying them, with option to approve, reject, or modify. Supports both individual email preview and batch preview mode.",
  "lastUpdated": "2025-01-05T20:35:00Z",
  "overallStatus": "pending",
  "phases": [
    {
      "id": "phase-1",
      "name": "Phase 1: Data Layer & Configuration",
      "description": "Implement configuration storage and repository for tag preview queue",
      "status": "pending",
      "subtasks": [
        {
          "id": "1.1",
          "title": "Extend IConfigRepository with preview mode settings",
          "description": "Add previewMode configuration to IAppConfig interface with fields: enabled (boolean), mode ('previewAll' | 'autoApply'), confidenceThreshold (number, 0-1)",
          "status": "pending",
          "files": [
            "src/infrastructure/interfaces/IConfigRepository.ts",
            "src/infrastructure/repositories/IndexedDBConfigRepository.ts"
          ],
          "acceptanceCriteria": [
            "IAppConfig interface includes previewMode settings",
            "IndexedDBConfigRepository implements preview mode persistence",
            "Default values: enabled=false, mode='previewAll', threshold=0.7"
          ],
          "estimatedTime": "1h"
        },
        {
          "id": "1.2",
          "title": "Create IPreviewQueue repository interface",
          "description": "Define interface for storing and managing pending tag suggestions with methods: addSuggestion(), getSuggestion(), removeSuggestion(), getAllPending(), clearPending(), updateSuggestionStatus()",
          "status": "pending",
          "files": [
            "src/infrastructure/interfaces/IPreviewQueue.ts"
          ],
          "acceptanceCriteria": [
            "Interface defines preview suggestion data structure (messageId, subject, proposedTags, confidence, timestamp, status)",
            "Methods for CRUD operations on suggestions",
            "Status enum: 'pending' | 'approved' | 'rejected' | 'modified'"
          ],
          "estimatedTime": "1h"
        },
        {
          "id": "1.3",
          "title": "Implement IndexedDBPreviewQueue repository",
          "description": "Create IndexedDB-based repository for preview queue with object store 'previewSuggestions' and indexes on messageId, status, timestamp",
          "status": "pending",
          "files": [
            "src/infrastructure/repositories/IndexedDBPreviewQueue.ts"
          ],
          "acceptanceCriteria": [
            "Full CRUD implementation of IPreviewQueue",
            "IndexedDB initialization with proper schema",
            "Index-based queries for efficient filtering",
            "Error handling and logging"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "1.4",
          "title": "Register preview queue in DI container",
          "description": "Add IndexedDBPreviewQueue to dependency injection container in background script",
          "status": "pending",
          "files": [
            "src/interfaces/background/index.ts"
          ],
          "acceptanceCriteria": [
            "IPreviewQueue registered in DI container",
            "Singleton lifecycle for queue instance",
            "Initialization called on background script startup"
          ],
          "estimatedTime": "0.5h"
        }
      ]
    },
    {
      "id": "phase-2",
      "name": "Phase 2: Domain & Application Logic",
      "description": "Create domain entities and update use cases for preview functionality",
      "status": "pending",
      "subtasks": [
        {
          "id": "2.1",
          "title": "Create TagSuggestion domain entity",
          "description": "Define domain entity representing a tag suggestion with validation, value objects for confidence scores and tag lists",
          "status": "pending",
          "files": [
            "src/domain/entities/TagSuggestion.ts",
            "src/domain/value-objects/ConfidenceScore.ts"
          ],
          "acceptanceCriteria": [
            "TagSuggestion entity with messageId, subject, proposedTags array, confidence, timestamp, status",
            "ConfidenceScore value object with validation (0-1 range)",
            "Immutable entity with factory methods",
            "Status transitions validation"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "2.2",
          "title": "Create PreviewQueue use case",
          "description": "Implement use case for managing preview queue: add suggestions, retrieve pending, approve/reject/modify, bulk operations",
          "status": "pending",
          "files": [
            "src/application/use-cases/ManagePreviewQueue.ts"
          ],
          "acceptanceCriteria": [
            "addSuggestion() - validates and stores tag suggestion",
            "getPendingSuggestions() - returns all pending suggestions",
            "approveSuggestion() - marks as approved and triggers tag application",
            "rejectSuggestion() - marks as rejected",
            "modifySuggestion() - updates tags and marks as modified",
            "approveAll()/rejectAll() - bulk operations",
            "Event publishing for state changes"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "2.3",
          "title": "Update AnalyzeEmail use case for preview mode",
          "description": "Modify AnalyzeEmail to check preview mode setting and store suggestions instead of auto-applying when enabled",
          "status": "pending",
          "files": [
            "src/application/use-cases/AnalyzeEmail.ts"
          ],
          "acceptanceCriteria": [
            "Reads previewMode config from IConfigRepository",
            "When preview disabled: applies tags directly (existing behavior)",
            "When preview enabled: stores suggestion in IPreviewQueue",
            "Respects confidence threshold in auto-apply mode",
            "Publishes different events for preview vs auto-apply",
            "Backward compatible with existing behavior"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "2.4",
          "title": "Create domain events for preview actions",
          "description": "Define events: SuggestionCreated, SuggestionApproved, SuggestionRejected, SuggestionModified, SuggestionAutoApplied",
          "status": "pending",
          "files": [
            "src/domain/events/PreviewEvents.ts"
          ],
          "acceptanceCriteria": [
            "Event definitions with proper typing",
            "Factory functions for each event type",
            "Event payloads include suggestion details and user actions",
            "Integration with EventBus"
          ],
          "estimatedTime": "1h"
        }
      ]
    },
    {
      "id": "phase-3",
      "name": "Phase 3: UI Components - Settings",
      "description": "Add preview mode settings to options page",
      "status": "pending",
      "subtasks": [
        {
          "id": "3.1",
          "title": "Add preview mode tab to options.html",
          "description": "Create new tab 'Tag Vorschau' with settings: enable preview, mode selection (preview all / auto-apply threshold), confidence threshold slider",
          "status": "pending",
          "files": [
            "options.html"
          ],
          "acceptanceCriteria": [
            "New tab button added to tab bar",
            "Settings form with checkbox for preview mode",
            "Radio buttons for mode selection",
            "Range slider for confidence threshold (0-100%)",
            "Help text explaining each option",
            "Save/cancel buttons"
          ],
          "estimatedTime": "1h"
        },
        {
          "id": "3.2",
          "title": "Style preview settings UI",
          "description": "Add CSS styles for preview mode tab, matching existing design system",
          "status": "pending",
          "files": [
            "options.css"
          ],
          "acceptanceCriteria": [
            "Consistent styling with existing tabs",
            "Responsive layout",
            "Visual feedback for enabled/disabled states",
            "Threshold slider styling with value display"
          ],
          "estimatedTime": "0.5h"
        },
        {
          "id": "3.3",
          "title": "Implement PreviewSettingsForm component",
          "description": "Create TypeScript component to handle preview settings form: load config, bind events, validate inputs, save to repository",
          "status": "pending",
          "files": [
            "src/interfaces/options/PreviewSettingsForm.ts"
          ],
          "acceptanceCriteria": [
            "Load current settings from IConfigRepository",
            "Form validation (threshold 0-100)",
            "Save settings to repository",
            "Success/error message display",
            "Event listener setup",
            "Dependency injection"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "3.4",
          "title": "Integrate PreviewSettingsForm in OptionsScript",
          "description": "Update OptionsScript to initialize PreviewSettingsForm when preview tab is activated",
          "status": "pending",
          "files": [
            "src/interfaces/options/OptionsScript.ts",
            "src/interfaces/options/index.ts"
          ],
          "acceptanceCriteria": [
            "PreviewSettingsForm registered in DI container",
            "Initialization on tab activation",
            "Clean lifecycle management",
            "Error handling"
          ],
          "estimatedTime": "1h"
        }
      ]
    },
    {
      "id": "phase-4",
      "name": "Phase 4: UI Components - Preview Panel",
      "description": "Create preview panel UI for reviewing tag suggestions",
      "status": "pending",
      "subtasks": [
        {
          "id": "4.1",
          "title": "Create preview panel HTML structure",
          "description": "Design and implement HTML for preview panel with two views: single email preview and batch preview list",
          "status": "pending",
          "files": [
            "options.html"
          ],
          "acceptanceCriteria": [
            "New tab 'Tag Vorschau' with suggestion list",
            "Single suggestion view: subject, proposed tags with confidence scores, approve/reject/modify buttons",
            "Batch view: table/list of pending suggestions with checkboxes",
            "Bulk approve/reject buttons",
            "Filter controls (all/pending/approved/rejected)",
            "Empty state message"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "4.2",
          "title": "Style preview panel UI",
          "description": "Create CSS for preview panel with modern, accessible design",
          "status": "pending",
          "files": [
            "options.css"
          ],
          "acceptanceCriteria": [
            "Tag display with color coding",
            "Confidence score visualization (progress bars or badges)",
            "Responsive layout for single and batch views",
            "Hover effects and transitions",
            "Status indicators (pending/approved/rejected)",
            "Loading states and animations"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "4.3",
          "title": "Implement PreviewPanel component",
          "description": "Create TypeScript component for rendering and managing preview panel: load suggestions, handle user actions, update UI",
          "status": "pending",
          "files": [
            "src/interfaces/options/PreviewPanel.ts"
          ],
          "acceptanceCriteria": [
            "Load pending suggestions from IPreviewQueue",
            "Render single and batch views",
            "Handle approve/reject/modify actions",
            "Real-time updates via message listener",
            "Confidence score formatting (percentage display)",
            "Tag modification UI (inline editing or modal)",
            "Error handling and user feedback",
            "Dependency injection"
          ],
          "estimatedTime": "3h"
        },
        {
          "id": "4.4",
          "title": "Implement tag modification UI",
          "description": "Create modal or inline interface for users to modify suggested tags before approval",
          "status": "pending",
          "files": [
            "src/interfaces/options/TagModificationModal.ts",
            "options.html",
            "options.css"
          ],
          "acceptanceCriteria": [
            "Modal displays current suggested tags",
            "Add/remove tag functionality",
            "Edit tag confidence scores",
            "Save/confirm and cancel buttons",
            "Validation (at least one tag required)",
            "Integration with PreviewPanel"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "4.5",
          "title": "Integrate PreviewPanel in OptionsScript",
          "description": "Update OptionsScript to initialize PreviewPanel and handle tab navigation",
          "status": "pending",
          "files": [
            "src/interfaces/options/OptionsScript.ts",
            "src/interfaces/options/index.ts"
          ],
          "acceptanceCriteria": [
            "PreviewPanel registered in DI container",
            "Initialization on preview tab activation",
            "Refresh when switching to preview tab",
            "Clean lifecycle management",
            "Message listener for background updates"
          ],
          "estimatedTime": "1h"
        }
      ]
    },
    {
      "id": "phase-5",
      "name": "Phase 5: Background Script Integration",
      "description": "Connect background script with preview queue and handle events",
      "status": "pending",
      "subtasks": [
        {
          "id": "5.1",
          "title": "Update EmailEventListener for preview mode",
          "description": "Modify email event listener to check preview mode and route to preview queue instead of direct tag application",
          "status": "pending",
          "files": [
            "src/interfaces/background/EmailEventListener.ts"
          ],
          "acceptanceCriteria": [
            "Read preview mode config before processing",
            "Route to preview queue when enabled",
            "Auto-apply above threshold when in auto-apply mode",
            "Maintain backward compatibility",
            "Error handling and logging"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "5.2",
          "title": "Create message handlers for preview actions",
          "description": "Implement browser runtime message handlers for approve/reject/modify actions from UI",
          "status": "pending",
          "files": [
            "src/interfaces/background/PreviewMessageHandler.ts"
          ],
          "acceptanceCriteria": [
            "Handler for 'preview:getSuggestions' message",
            "Handler for 'preview:approve' message",
            "Handler for 'preview:reject' message",
            "Handler for 'preview:modify' message",
            "Handler for 'preview:bulkApprove' and 'preview:bulkReject'",
            "Response messages with updated suggestion data",
            "Error responses with proper error messages"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "5.3",
          "title": "Implement notification system for new suggestions",
          "description": "Create optional notification when new tag suggestions are added to preview queue",
          "status": "pending",
          "files": [
            "src/interfaces/background/PreviewNotificationManager.ts"
          ],
          "acceptanceCriteria": [
            "Check notification preference in app config",
            "Show browser notification for new suggestions",
            "Notification includes email subject and tag count",
            "Click action opens preview panel",
            "Rate limiting to avoid spam",
            "Configurable enable/disable"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "5.4",
          "title": "Update background script initialization",
          "description": "Update background.ts to register preview queue, message handlers, and notification manager",
          "status": "pending",
          "files": [
            "src/interfaces/background/index.ts"
          ],
          "acceptanceCriteria": [
            "Register all preview-related services in DI",
            "Initialize preview queue repository",
            "Register message handlers",
            "Setup event subscriptions",
            "Error handling and logging"
          ],
          "estimatedTime": "1h"
        }
      ]
    },
    {
      "id": "phase-6",
      "name": "Phase 6: Testing & Documentation",
      "description": "Write tests and documentation for preview functionality",
      "status": "pending",
      "subtasks": [
        {
          "id": "6.1",
          "title": "Write unit tests for TagSuggestion entity",
          "description": "Test entity creation, validation, immutability, and status transitions",
          "status": "pending",
          "files": [
            "tests/unit/TagSuggestion.test.ts"
          ],
          "acceptanceCriteria": [
            "Test factory methods",
            "Test validation (confidence range, required fields)",
            "Test status transition rules",
            "Test immutability",
            "Edge cases and error conditions"
          ],
          "estimatedTime": "1h"
        },
        {
          "id": "6.2",
          "title": "Write unit tests for PreviewQueue use case",
          "description": "Test all queue operations: add, get, approve, reject, modify, bulk operations",
          "status": "pending",
          "files": [
            "tests/unit/ManagePreviewQueue.test.ts"
          ],
          "acceptanceCriteria": [
            "Test addSuggestion with valid/invalid data",
            "Test getPendingSuggestions filters",
            "Test approve/reject/modify operations",
            "Test bulk approve/reject",
            "Test event publishing",
            "Mock IPreviewQueue repository",
            "Test error handling"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "6.3",
          "title": "Write integration tests for preview flow",
          "description": "Test complete flow from email analysis to tag application via preview queue",
          "status": "pending",
          "files": [
            "tests/integration/previewFlow.test.ts"
          ],
          "acceptanceCriteria": [
            "Test preview disabled: direct tag application",
            "Test preview enabled: suggestion stored",
            "Test approve flow: suggestion â†’ tag application",
            "Test reject flow: suggestion marked rejected",
            "Test modify flow: modified tags applied",
            "Test auto-apply threshold behavior",
            "Test confidence threshold filtering",
            "Test bulk operations",
            "End-to-end scenarios"
          ],
          "estimatedTime": "3h"
        },
        {
          "id": "6.4",
          "title": "Write UI component tests",
          "description": "Test PreviewSettingsForm and PreviewPanel components with mocked dependencies",
          "status": "pending",
          "files": [
            "tests/ui/PreviewSettingsForm.test.ts",
            "tests/ui/PreviewPanel.test.ts"
          ],
          "acceptanceCriteria": [
            "Test form initialization",
            "Test user interactions (approve/reject/modify)",
            "Test form submission and validation",
            "Test UI updates on data changes",
            "Test error message display",
            "Mock DOM and browser APIs"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "6.5",
          "title": "Write repository tests for IndexedDBPreviewQueue",
          "description": "Test IndexedDB operations with in-memory database",
          "status": "pending",
          "files": [
            "tests/integration/IndexedDBPreviewQueue.test.ts"
          ],
          "acceptanceCriteria": [
            "Test CRUD operations",
            "Test index-based queries",
            "Test filtering by status",
            "Test bulk operations",
            "Test error handling",
            "Clean up test data"
          ],
          "estimatedTime": "2h"
        },
        {
          "id": "6.6",
          "title": "Create user documentation",
          "description": "Write documentation for preview feature: how to enable, use, and configure",
          "status": "pending",
          "files": [
            "docs/user-guide/preview-mode.md"
          ],
          "acceptanceCriteria": [
            "Feature overview and benefits",
            "Step-by-step setup guide",
            "How to review suggestions",
            "How to approve/reject/modify",
            "Explanation of confidence scores",
            "Auto-apply threshold explanation",
            "Screenshots and examples",
            "Troubleshooting section"
          ],
          "estimatedTime": "1.5h"
        },
        {
          "id": "6.7",
          "title": "Update ARCHITECTURE.md",
          "description": "Document new components, interfaces, and data flow for preview functionality",
          "status": "pending",
          "files": [
            "ARCHITECTURE.md"
          ],
          "acceptanceCriteria": [
            "Add TagSuggestion entity to domain layer",
            "Add IPreviewQueue to infrastructure interfaces",
            "Add ManagePreviewQueue to application layer",
            "Add UI components to interface layer",
            "Update data flow diagrams",
            "Document preview mode configuration",
            "Update migration status"
          ],
          "estimatedTime": "1h"
        }
      ]
    }
  ],
  "dependencies": {
    "external": [],
    "internal": [
      "src/infrastructure/interfaces/IConfigRepository.ts",
      "src/infrastructure/repositories/IndexedDBConfigRepository.ts",
      "src/application/use-cases/AnalyzeEmail.ts",
      "src/application/use-cases/ApplyTagsToEmail.ts",
      "src/domain/events/EventBus.ts",
      "src/interfaces/options/OptionsScript.ts"
    ]
  },
  "risks": [
    {
      "id": "risk-1",
      "description": "IndexedDB quota may be exceeded with many pending suggestions",
      "mitigation": "Implement automatic cleanup of old suggestions, add size monitoring"
    },
    {
      "id": "risk-2",
      "description": "UI performance may degrade with large suggestion lists",
      "mitigation": "Implement pagination or virtual scrolling for batch view"
    },
    {
      "id": "risk-3",
      "description": "Complex state management between background script and UI",
      "mitigation": "Use clear message protocol, implement proper synchronization"
    },
    {
      "id": "risk-4",
      "description": "Backward compatibility with existing auto-apply behavior",
      "mitigation": "Default preview mode to disabled, thorough testing of both modes"
    }
  ],
  "estimatedTotalTime": "42h",
  "priority": "medium",
  "complexity": "medium-high",
  "status": "backlog",
  "planStatus": "pending",
  "updated_at": "2026-01-05T19:36:23.434Z"
}