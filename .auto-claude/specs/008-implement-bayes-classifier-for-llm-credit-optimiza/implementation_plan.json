{
  "feature": "Bayes Classifier for LLM Credit Optimization",
  "workflow_type": "feature",
  "workflow_rationale": "New feature requiring multiple phases: setup, storage infrastructure, core ML services, pipeline integration, configuration, and end-to-end testing. Each phase builds on the previous, with strict dependencies (can't build pipeline before storage exists, can't integrate before services are implemented).",
  "phases": [
    {
      "id": "phase-1-setup",
      "name": "Setup & Infrastructure",
      "type": "setup",
      "description": "Install Bayes library dependency, add manifest permissions, and define type system for Bayes classifier feature",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Install @thomaschampagne/naive-bayes dependency",
          "service": "main",
          "files_to_modify": [
            "package.json"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep '@thomaschampagne/naive-bayes' package.json",
            "expected": "@thomaschampagne/naive-bayes"
          },
          "status": "completed",
          "notes": "Successfully installed @thomaschampagne/naive-bayes dependency in package.json. Verification passed.",
          "updated_at": "2026-01-05T19:23:12.257524+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Add unlimitedStorage permission to manifest.json",
          "service": "main",
          "files_to_modify": [
            "manifest.json"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep 'unlimitedStorage' manifest.json",
            "expected": "unlimitedStorage"
          },
          "status": "completed",
          "notes": "Successfully added unlimitedStorage permission to manifest.json. Verification passed: grep command found \"unlimitedStorage\" in the file.",
          "updated_at": "2026-01-05T19:24:23.411717+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Create BayesTypes with type definitions for classifiers, metrics, config",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/shared/types/BayesTypes.ts"
          ],
          "patterns_from": [
            "src/shared/types/ProviderTypes.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check",
            "expected": "0 errors (exit code 0)"
          },
          "status": "completed",
          "notes": "Successfully created BayesTypes.ts with comprehensive type definitions for classifiers, metrics, and configuration. Verification passed: npm run type-check completed with 0 errors. File includes interfaces for training data, classifier metrics, Bayesian models, validation, cross-validation, and hyperparameter search - covering all requirements for Bayes classifier system.",
          "updated_at": "2026-01-05T20:22:00.000000+00:00"
        }
      ]
    },
    {
      "id": "phase-2-storage",
      "name": "Storage Layer",
      "type": "implementation",
      "description": "Create browser.storage.local repository for persisting Bayes classifier models, training data, and accuracy metrics",
      "depends_on": [
        "phase-1-setup"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Create ClassifierStorageRepository for Bayes model CRUD operations",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/infrastructure/repositories/ClassifierStorageRepository.ts"
          ],
          "patterns_from": [
            "src/infrastructure/repositories/IndexedDBConfigRepository.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check",
            "expected": "0 errors"
          },
          "status": "completed",
          "notes": "Successfully created ClassifierStorageRepository for Bayes model CRUD operations. Created IClassifierStorageRepository interface with comprehensive methods for model management, training data, performance metrics, and audit logs. Implementation follows existing patterns from IndexedDBConfigRepository using browser.storage.local. All TypeScript type checking passes.",
          "updated_at": "2026-01-05T19:31:30.423829+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Add storage interface IClassifierStorage to infrastructure interfaces",
          "service": "main",
          "files_to_modify": [
            "src/infrastructure/interfaces/IConfigRepository.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/infrastructure/interfaces/IConfigRepository.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm run type-check",
            "expected": "0 errors"
          },
          "status": "completed",
          "notes": "Successfully added IClassifierStorage interface to IConfigRepository.ts with comprehensive methods for classifier training data management, performance metrics tracking, and storage operations. All TypeScript type checking passes with 0 errors.",
          "updated_at": "2026-01-05T19:33:08.173327+00:00"
        }
      ]
    },
    {
      "id": "phase-3-core-services",
      "name": "Core Bayes Services",
      "type": "implementation",
      "description": "Implement Bayes classifier manager and accuracy tracking system",
      "depends_on": [
        "phase-2-storage"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Implement BayesClassifierManager for per-tag classifier lifecycle",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/domain/services/BayesClassifierManager.ts"
          ],
          "patterns_from": [
            "src/domain/services/TagService.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm test -- --run BayesClassifierManager",
            "expected": "PASS"
          },
          "status": "completed",
          "notes": "Successfully implemented BayesClassifierManager with per-tag classifier lifecycle management. The service provides methods for creating, loading, training, and classifying emails using Naive Bayes classifiers. All tests pass and the implementation follows the established patterns from TagService.",
          "updated_at": "2026-01-05T19:44:08.854195+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Implement AccuracyTracker for per-tag metrics (TP, FP, accuracy)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/domain/services/AccuracyTracker.ts"
          ],
          "patterns_from": [
            "src/domain/services/TagService.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm test -- --run AccuracyTracker",
            "expected": "PASS"
          },
          "status": "completed",
          "notes": "AccuracyTracker already implemented and tests are passing. Implementation includes per-tag metrics tracking (TP, FP, accuracy, precision, recall, F1-score) with comprehensive functionality for recording predictions, calculating metrics, and providing summary statistics.",
          "updated_at": "2026-01-05T19:52:22.875149+00:00"
        }
      ]
    },
    {
      "id": "phase-4-pipeline",
      "name": "Two-Stage Pipeline",
      "type": "implementation",
      "description": "Build two-stage classification pipeline (Bayes → LLM verification) with active learning",
      "depends_on": [
        "phase-3-core-services"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Implement TwoStageClassificationPipeline orchestrating Bayes → LLM flow",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/application/services/TwoStageClassificationPipeline.ts"
          ],
          "patterns_from": [
            "src/application/use-cases/AnalyzeEmail.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm test -- --run TwoStageClassificationPipeline",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Implement ActiveLearningService to collect mismatches for training",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/application/services/ActiveLearningService.ts"
          ],
          "patterns_from": [
            "src/application/use-cases/AnalyzeEmail.ts"
          ],
          "verification": {
            "type": "command",
            "command": "npm test -- --run ActiveLearningService",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-3",
          "description": "Integrate TwoStageClassificationPipeline into AnalyzeEmail use case",
          "service": "main",
          "files_to_modify": [
            "src/application/use-cases/AnalyzeEmail.ts"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "api",
            "method": "POST",
            "url": "http://localhost:11434/api/generate",
            "body": "{\"model\": \"test\", \"prompt\": \"test\"}",
            "expected_status": 200
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-config-ui",
      "name": "Configuration & UI",
      "type": "implementation",
      "description": "Add Bayes feature configuration system and UI controls",
      "depends_on": [
        "phase-3-core-services"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Extend AppConfig with Bayes feature settings (enabled, threshold, sampling rate)",
          "service": "main",
          "files_to_modify": [
            "src/infrastructure/config/AppConfig.ts"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm run type-check",
            "expected": "0 errors"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Add Bayes configuration controls to SettingsForm UI",
          "service": "main",
          "files_to_modify": [
            "src/interfaces/options/SettingsForm.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/interfaces/options/SettingsForm.ts"
          ],
          "verification": {
            "type": "browser",
            "url": "chrome-extension://[id]/options.html",
            "checks": [
              "Bayes toggle visible",
              "Accuracy threshold slider visible",
              "Sampling rate slider visible"
            ]
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "Add per-tag accuracy display and retrain button to OptionsScript",
          "service": "main",
          "files_to_modify": [
            "src/interfaces/options/OptionsScript.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/interfaces/options/OptionsScript.ts"
          ],
          "verification": {
            "type": "browser",
            "url": "chrome-extension://[id]/options.html",
            "checks": [
              "Per-tag accuracy metrics visible",
              "Retrain button functional"
            ]
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-6-integration",
      "name": "Integration & Testing",
      "type": "integration",
      "description": "End-to-end integration testing and comprehensive test coverage",
      "depends_on": [
        "phase-4-pipeline",
        "phase-5-config-ui"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Write unit tests for all Bayes classifier components",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "test/unit/BayesClassifierService.test.ts",
            "test/unit/AccuracyTracker.test.ts",
            "test/unit/ClassifierStorage.test.ts"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm test -- --run test/unit",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-2",
          "description": "Write integration tests for Bayes → LLM pipeline",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "test/integration/BayesPipeline.integration.test.ts"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm test -- --run test/integration",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-3",
          "description": "Write E2E tests for complete Bayes workflow (training, accuracy, adaptive sampling)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "test/e2e/BayesWorkflow.e2e.test.ts"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "npm test -- --run test/e2e",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-6-4",
          "description": "Verify end-to-end Bayes classifier workflow with real email classification",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Load extension in Thunderbird",
              "Create new tag 'urgent'",
              "Send 50 test emails",
              "Verify Bayes classifier created for 'urgent' tag",
              "Verify training data stored in browser.storage.local",
              "Verify accuracy metrics tracked",
              "After 90% accuracy, verify LLM sampling reduced to 20%",
              "Disable feature, verify fallback to pure LLM"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 19,
    "services_involved": [
      "main"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-5-config-ui"
          ],
          "reason": "Phase 5 only depends on phase-3-core-services, can run in parallel with phase-4-pipeline"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution recommended due to tight coupling between phases"
    },
    "startup_command": "npm run build:dev && npm test -- --watch"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "e2e"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All unit tests pass with ≥80% coverage",
      "All integration tests pass",
      "All E2E tests pass",
      "Bayes classifiers created and stored for each tag",
      "Two-stage classification pipeline works correctly",
      "Active learning loop trains from LLM corrections",
      "Accuracy metrics tracked and persisted",
      "LLM usage reduces to sampling rate after accuracy threshold",
      "Feature enabled by default with configuration UI",
      "browser.storage.local persists models and training data",
      "unlimitedStorage permission added to manifest",
      "No regressions in existing LLM classification",
      "Works across Firefox and Chrome browsers"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "npm test -- --run test/unit",
        "expected_outcome": "All unit tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "npm test -- --run test/integration",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "E2E Tests",
        "command": "npm test -- --run test/e2e",
        "expected_outcome": "All E2E tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "TypeScript Compilation",
        "command": "npm run type-check",
        "expected_outcome": "0 TypeScript errors",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Linting",
        "command": "npm run lint",
        "expected_outcome": "0 linting errors",
        "type": "test",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "High-risk core feature affecting email classification accuracy. Requires comprehensive testing: unit tests for Bayes classifier logic and storage operations, integration tests for the Bayes→LLM pipeline and active learning, and E2E tests for the complete workflow including accuracy tracking and adaptive sampling. No security scan needed (browser-local data only, no auth/payment). No staging deployment (Thunderbird extension with local storage)."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "npm test -- --run test/unit"
      ],
      "minimum_coverage": 80
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "npm test -- --run test/integration"
      ],
      "services_to_test": [
        "main"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "npm test -- --run test/e2e"
      ],
      "flows": [
        "initial-training",
        "accuracy-threshold",
        "accuracy-degradation",
        "feature-toggle",
        "tag-lifecycle",
        "storage-persistence"
      ]
    },
    "browser_verification": {
      "required": true,
      "pages": [
        {
          "url": "chrome-extension://[id]/options.html",
          "checks": [
            "renders",
            "bayes-controls-visible",
            "no-console-errors"
          ]
        }
      ]
    },
    "storage_verification": {
      "required": true,
      "checks": [
        "storage-keys-exist",
        "classifier-models-stored",
        "training-data-stored",
        "metrics-persisted",
        "config-persisted"
      ]
    }
  },
  "qa_signoff": null,
  "last_updated": "2026-01-05T19:52:22.875166+00:00",
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-05T19:53:02.163Z"
}